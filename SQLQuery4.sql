-- TABLE

CREATE TABLE AGEGROUP(
AGE_GROUP_CODE INT NOT NULL,
DESCRIPTION NVARCHAR(250),
PRIMARY KEY(AGE_GROUP_CODE)
);

CREATE TABLE VACCINE(
VNAME NVARCHAR(250) NOT NULL,
FORMULA NVARCHAR(250),
MADEBY NVARCHAR(250),
PRIMARY KEY(VNAME),
);

CREATE TABLE ICUGROUP(
ICU_CODE NVARCHAR(250) NOT NULL,
DESCRIPTION NVARCHAR(250),
PRIMARY KEY(ICU_CODE)
)

CREATE TABLE PROVINCE(
PROVID CHAR(5) NOT NULL,
PROVINCE_NAME NVARCHAR(250) NOT NULL,
total_cases INT,
total_fatalities INT, 
total_tests INT,
total_hospitalizations INT,
total_criticals INT,
total_recoveries INT,
total_vaccinations INT,
total_vaccinated INT, 
total_boosters_1 INT,
total_boosters_2 INT,
total_vaccines_distributed INT,
PRIMARY KEY(PROVID)
);

CREATE TABLE HEALTHREGION(
HEAREGID CHAR(25) NOT NULL,
HEALTHREGION_NAME NVARCHAR(250) NOT NULL,
PROVID CHAR(5),
PRIMARY KEY(HEAREGID),
FOREIGN KEY(PROVID) REFERENCES PROVINCE(PROVID)
);


CREATE TABLE VACCINATION (
VACID INT NOT NULL,
VACNAME NVARCHAR(250) NOT NULL,
VACDATE DATETIME,
DOSE INT,
PRIMARY KEY(VACID),
FOREIGN KEY(VACNAME) REFERENCES VACCINE(VNAME)
);

CREATE TABLE PERSON(
SSN INT NOT NULL,
NAME NVARCHAR(250),
AGE INT,
JOBTYPE NVARCHAR(250),
AGE_GROUP_CODE INT NOT NULL,
PRIMARY KEY(SSN),
FOREIGN KEY(AGE_GROUP_CODE) REFERENCES AGEGROUP(AGE_GROUP_CODE)
);

CREATE TABLE PHU(
PHUID INT NOT NULL,
NAME NVARCHAR(250),
CITY NVARCHAR(250),
PROVID CHAR(5),
HEAREGID CHAR(25),
ADDRESS NVARCHAR(250),
TOTAL_TESTS BIGINT,
POSITIVE_TESTS BIGINT,
POSITIVE_RATE FLOAT(2),
PRIMARY KEY(PHUID),
FOREIGN KEY(PROVID) REFERENCES PROVINCE(PROVID),
FOREIGN KEY(HEAREGID) REFERENCES HEALTHREGION(HEAREGID),
);


CREATE TABLE TEST(
TESTSID INT NOT NULL IDENTITY(1,1) PRIMARY KEY,
TESTING_DATE DATETIME,
RESULT INT,
AGE_GROUP_CODE INT NOT NULL,
PROVID CHAR(5) NOT NULL,
FOREIGN KEY(PROVID) REFERENCES PROVINCE(PROVID),
FOREIGN KEY(AGE_GROUP_CODE) REFERENCES AGEGROUP(AGE_GROUP_CODE)
);


-- RELATIONSHIPS

CREATE TABLE PEOPLE_VACCINATION_RECORDS(
SSN INT NOT NULL,
VACID INT NOT NULL,
PRIMARY KEY(SSN, VACID),
FOREIGN KEY(SSN) REFERENCES PERSON(SSN),
FOREIGN KEY(VACID) REFERENCES VACCINATION(VACID)
);

CREATE TABLE PHU_VACCINATION(
VACID INT NOT NULL,
PHUID INT NOT NULL,
FOREIGN KEY(PHUID) REFERENCES PHU(PHUID),
FOREIGN KEY(VACID) REFERENCES VACCINATION(VACID)
);


CREATE TABLE PERSON_TEST(
SSN INT NOT NULL,
TESTSID INT NOT NULL,
PRIMARY KEY(SSN, TESTSID),
FOREIGN KEY(SSN) REFERENCES PERSON(SSN),
FOREIGN KEY(TESTSID) REFERENCES TEST(TESTSID)
);

CREATE TABLE PHU_TEST(
TESTSID INT NOT NULL,
PHUID INT NOT NULL,
PRIMARY KEY(PHUID, TESTSID),
FOREIGN KEY(TESTSID) REFERENCES TEST(TESTSID),
FOREIGN KEY(PHUID) REFERENCES PHU(PHUID),
);

CREATE TABLE HOSPITALIZATION_RECORDS(
SSN INT NOT NULL,
PHUID INT NOT NULL,
REPORTING_DATE DATETIME,
ICU_CODE NVARCHAR(250) NOT NULL,
PRIMARY KEY(SSN,PHUID),
FOREIGN KEY(ICU_CODE) REFERENCES ICUGROUP(ICU_CODE),
FOREIGN KEY(SSN) REFERENCES PERSON(SSN),
FOREIGN KEY(PHUID) REFERENCES PHU(PHUID)
);

-- INDEX
 
-- TRIGGER
 
-- VIEW


-- VACCINE
INSERT INTO VACCINE VALUES('Astrazeneca', 'Adenoviruses', 'Astrazeneca');
INSERT INTO VACCINE VALUES('Johnson and Johnson', 'viral vector', 'Johnson and Johnson');
INSERT INTO VACCINE VALUES('Moderna', 'mRNA', 'Moderna');
INSERT INTO VACCINE VALUES('Pfizer', 'mRNA', 'Pfizer');

-- AGEGROUP
INSERT INTO AGEGROUP VALUES(1, '0-11 years old');
INSERT INTO AGEGROUP VALUES(2, '12-17 years old');
INSERT INTO AGEGROUP VALUES(3, '18-39 years old');
INSERT INTO AGEGROUP VALUES(4, '40-59 years old');
INSERT INTO AGEGROUP VALUES(5, '60-79 years old');
INSERT INTO AGEGROUP VALUES(6, '80+ years old');


-- ICUGROUP
INSERT INTO ICUGROUP VALUES('icu_current_covid', 'ICUs with COVID-19');
INSERT INTO ICUGROUP VALUES('icu_current_covid_vented', 'ICUs on ventilators due to COVID-related critical illness');
INSERT INTO ICUGROUP VALUES('icu_hospitalizations', 'Hospitalizations with COVID-19');
INSERT INTO ICUGROUP VALUES('icu_crci_total', 'ICUs due to COVID-related critical illness');
INSERT INTO ICUGROUP VALUES('icu_crci_total_vented', 'ICUs on ventilators due to COVID-related critical illness');
INSERT INTO ICUGROUP VALUES('icu_former_covid', 'ICUs no longer testing positive for COVID');
INSERT INTO ICUGROUP VALUES('icu_former_covid_vented', 'ICUs on ventilators no longer testing positive for COVID');


-- PROVINCE
INSERT INTO PROVINCE(PROVID, PROVINCE_NAME) VALUES('NL', 'Newfoundland and Labrador');
INSERT INTO PROVINCE(PROVID, PROVINCE_NAME) VALUES('PE', 'Prince Edward Island');
INSERT INTO PROVINCE(PROVID, PROVINCE_NAME) VALUES('NS', 'Nova Scotia');
INSERT INTO PROVINCE(PROVID, PROVINCE_NAME) VALUES('NB', 'New Brunswick');
INSERT INTO PROVINCE(PROVID, PROVINCE_NAME) VALUES('QC', 'Quebec');
INSERT INTO PROVINCE(PROVID, PROVINCE_NAME) VALUES('ON', 'Ontario');
INSERT INTO PROVINCE(PROVID, PROVINCE_NAME) VALUES('MB', 'Manitoba');
INSERT INTO PROVINCE(PROVID, PROVINCE_NAME) VALUES('SK', 'Saskatchewan');
INSERT INTO PROVINCE(PROVID, PROVINCE_NAME) VALUES('AB', 'Alberta');
INSERT INTO PROVINCE(PROVID, PROVINCE_NAME) VALUES('BC', 'British Columbia');
INSERT INTO PROVINCE(PROVID, PROVINCE_NAME) VALUES('YT', 'Yukon');
INSERT INTO PROVINCE(PROVID, PROVINCE_NAME) VALUES('NT', 'Northwest Territories');
INSERT INTO PROVINCE(PROVID, PROVINCE_NAME) VALUES('NU', 'Nunavut');


-- HEALTHREGION
INSERT INTO HEALTHREGION VALUES('CENTRAL', 'Central Region', 'ON');
INSERT INTO HEALTHREGION VALUES('WEST', 'West Region', 'ON');
INSERT INTO HEALTHREGION VALUES('EAST', 'East Region', 'ON');
INSERT INTO HEALTHREGION VALUES('NORTH', 'Central Region', 'ON');
INSERT INTO HEALTHREGION VALUES('TORONTO', 'Toronto Region', 'ON');
INSERT INTO HEALTHREGION VALUES('Fraser', 'Fraser Health Authority ', 'BC');
INSERT INTO HEALTHREGION VALUES('Vancouver', 'Vancouver Island Health Authority ', 'BC');
INSERT INTO HEALTHREGION VALUES('NORTH396', 'Northern Health Authority', 'BC');
INSERT INTO HEALTHREGION VALUES('CZN', 'Alberta Health Services - Calgary Zone ', 'AB');
INSERT INTO HEALTHREGION VALUES('EZ', 'Alberta Health Services - Edmonton Zone', 'AB');
INSERT INTO HEALTHREGION VALUES('IERHA', 'Interlake-Eastern Regional Health Authority', 'MB');
INSERT INTO HEALTHREGION VALUES('WRHA', 'Winnipeg Regional Health Authority', 'MB');
INSERT INTO HEALTHREGION VALUES('PMH', 'Prairie Mountain Health', 'MB');
INSERT INTO HEALTHREGION VALUES('CISSSO', 'Centre intégré de santé et de services sociaux de lOutaouais', 'QC');
INSERT INTO HEALTHREGION VALUES('CIUSSS-SLSJ', 'Centre intégré universitaire de santé et de services sociaux du Saguenay-Lac-Saint-Jean', 'QC');
INSERT INTO HEALTHREGION VALUES('CZ', 'Nova Scotia Health Authority - Central Zone', 'NS');
INSERT INTO HEALTHREGION VALUES('WZ', 'Nova Scotia Health Authority - Western Zone', 'NS');

--VACCINATION
INSERT INTO VACCINATION VALUES(1, 'Moderna', '20220618 10:34:09 AM', 1);
INSERT INTO VACCINATION VALUES(2, 'Astrazeneca', '20220619 10:34:09 AM', 1);
INSERT INTO VACCINATION VALUES(3, 'Moderna', '20220620 10:34:09 AM', 1);
INSERT INTO VACCINATION VALUES(4, 'Pfizer', '20220621 10:34:09 AM', 1);
INSERT INTO VACCINATION VALUES(5, 'Pfizer', '20220622 10:34:09 AM', 1);


--PERSON
INSERT INTO PERSON VALUES (123456789, 'John Smith', 35, 'Software Engineer', 3);
INSERT INTO PERSON VALUES (987654321, 'Jane Doe', 45, 'Marketing Manager', 4);
INSERT INTO PERSON VALUES (234567890, 'Jane Smith', 25, 'Engineer', 3);
INSERT INTO PERSON VALUES (345678901, 'Bob Doe', 45, 'Salesperson', 4);
INSERT INTO PERSON VALUES (345678902, 'John Van', 42, 'Engineer', 4);
INSERT INTO PERSON VALUES (346549025, 'Bear Sae', 15, 'Marketing', 2);
INSERT INTO PERSON VALUES (376678904, 'Peter Mao', 42, 'Designer', 3);
INSERT INTO PERSON VALUES (246810214, 'Bob Johnson', 28, 'Graphic Designer', 3);
INSERT INTO PERSON VALUES (456789123, 'Michael Brown', 82, 'Retirement', 6);
INSERT INTO PERSON VALUES (654321987, 'Sarah Johnson', 5, 'Student', 1);
INSERT INTO PERSON VALUES (789456123, 'David Lee', 61, 'Accountant', 5);
INSERT INTO PERSON VALUES (234567891, 'Emily Davis', 6, 'Student', 1);
INSERT INTO PERSON VALUES (321654987, 'Amanda White', 84, 'Teacher', 6);
INSERT INTO PERSON VALUES (369258147, 'Lisa Chen', 16, 'Nurse', 2);

--PEOPLE_VACCINATION
INSERT INTO PEOPLE_VACCINATION_RECORDS VALUES (123456789, 3);
INSERT INTO PEOPLE_VACCINATION_RECORDS VALUES (987654321, 4);
INSERT INTO PEOPLE_VACCINATION_RECORDS VALUES (246810214, 1);
INSERT INTO PEOPLE_VACCINATION_RECORDS VALUES (234567890, 2);
INSERT INTO PEOPLE_VACCINATION_RECORDS VALUES (345678901, 5);

-- PHU
INSERT INTO PHU(PHUID, NAME, CITY, PROVID, HEAREGID, ADDRESS)
VALUES(1, 'ALGOMA DISTRICT', 'Toronto', 'ON', 'TORONTO', '123 Main St.');

INSERT INTO PHU(PHUID, NAME, CITY, PROVID, HEAREGID, ADDRESS)
VALUES(2, 'BRANT COUNTY', 'London', 'ON', 'WEST', '456 Oak St.');

INSERT INTO PHU(PHUID, NAME, CITY, PROVID, HEAREGID, ADDRESS)
VALUES(3, 'PQR Clinic', 'Chatham', 'ON', 'CENTRAL', '789 Elm St.');

INSERT INTO PHU(PHUID, NAME, CITY, PROVID, HEAREGID, ADDRESS)
VALUES(4, 'LMN Hospital', 'Calgary', 'ON', 'NORTH', '567 Maple Ave.');

INSERT INTO PHU(PHUID, NAME, CITY, PROVID, HEAREGID, ADDRESS)
VALUES(5, 'EFG Clinic', 'Halifax', 'ON', 'EAST', '987 Pine St.');

INSERT INTO PHU(PHUID, NAME, CITY, PROVID, HEAREGID, ADDRESS)
VALUES(6, 'RST Hospital', 'Windsor', 'ON', 'NORTH', '321 Birch Rd.');

INSERT INTO PHU(PHUID, NAME, CITY, PROVID, HEAREGID, ADDRESS)
VALUES(7, 'UVW Clinic', 'London', 'ON', 'CENTRAL', '654 Cedar St.');

INSERT INTO PHU(PHUID, NAME, CITY, PROVID, HEAREGID, ADDRESS)
VALUES(8, 'Fraser Health Authority', 'Fraser', 'BC', 'Fraser', '13450 - 102nd Avenue');

INSERT INTO PHU(PHUID, NAME, CITY, PROVID, HEAREGID, ADDRESS)
VALUES(9, 'Vancouver Island Health Authority', 'Vancouver', 'BC', 'Vancouver', '1952 Bay Street');

INSERT INTO PHU(PHUID, NAME, CITY, PROVID, HEAREGID, ADDRESS)
VALUES(10, 'Calgary Zone Medical Officer of Health', 'Calgary', 'AB', 'CZN', '1213 - 4th Street SW');

INSERT INTO PHU(PHUID, NAME, CITY, PROVID, HEAREGID, ADDRESS)
VALUES(11, 'Alberta Health Services - Edmonton Zone', 'Edmonton', 'AB', 'EZ', '10959 - 102 Street NW');

INSERT INTO PHU(PHUID, NAME, CITY, PROVID, HEAREGID, ADDRESS)
VALUES(12, 'Interlake-Eastern Regional Health Authority', 'Manitoba', 'MB', 'WRHA', '160 Veterans Lane');

INSERT INTO PHU(PHUID, NAME, CITY, PROVID, HEAREGID, ADDRESS)
VALUES(13, 'Northern Regional Health Authority', 'Thompson', 'MB', 'PMH', '867 Thompson Drive South');

INSERT INTO PHU(PHUID, NAME, CITY, PROVID, HEAREGID, ADDRESS)
VALUES(14, 'Nova Scotia Health Authority - Central Zone', 'Nova Scotia', 'NS', 'CZ', '1276 South Park Street');

INSERT INTO PHU(PHUID, NAME, CITY, PROVID, HEAREGID, ADDRESS)
VALUES(15, 'Nova Scotia Health Authority - Western Zone', 'Nova Scotia', 'NS', 'WZ', 'PO Box 130 Bridgewater, NS B4V 2W6');

INSERT INTO PHU(PHUID, NAME, CITY, PROVID, HEAREGID, ADDRESS)
VALUES(16, 'Centre intégré universitaire de santé et de services sociaux de lEstrie - CHUS', 'Quebec', 'QC', 'CISSSO', '3001, 12e Avenue Nord');

INSERT INTO PHU(PHUID, NAME, CITY, PROVID, HEAREGID, ADDRESS)
VALUES(17, 'Centre intégré universitaire sociaux de lEstrie - CHUSUED', 'Quebec', 'QC', 'CIUSSS-SLSJ', 'Sherbrooke, QC J1H 5N4');


--TEST
INSERT INTO TEST(TESTING_DATE, RESULT, AGE_GROUP_CODE, PROVID) VALUES ('2022-10-05 13:45:00', 1, 3, 'ON');
INSERT INTO TEST(TESTING_DATE, RESULT, AGE_GROUP_CODE, PROVID) VALUES ('2022-09-25 10:30:00', 0, 3, 'ON');
INSERT INTO TEST(TESTING_DATE, RESULT, AGE_GROUP_CODE, PROVID) VALUES ('2022-11-01 08:15:00', 1, 4, 'ON');
INSERT INTO TEST(TESTING_DATE, RESULT, AGE_GROUP_CODE, PROVID) VALUES ('2022-08-10 16:00:00', 1, 4, 'ON');
INSERT INTO TEST(TESTING_DATE, RESULT, AGE_GROUP_CODE, PROVID) VALUES ('2022-12-15 09:45:00', 0, 3, 'ON');
INSERT INTO TEST(TESTING_DATE, RESULT, AGE_GROUP_CODE, PROVID) VALUES ('2022-11-23 14:30:00', 1, 4, 'ON');


--PHU_VACCINATION
INSERT INTO PHU_VACCINATION VALUES (3,1);
INSERT INTO PHU_VACCINATION VALUES (4,1);
INSERT INTO PHU_VACCINATION VALUES (1,2);
INSERT INTO PHU_VACCINATION VALUES (2,1);
INSERT INTO PHU_VACCINATION VALUES (5,3);


--PERSON_TEST
INSERT INTO PERSON_TEST VALUES (123456789, 3);
INSERT INTO PERSON_TEST VALUES (987654321, 4);
INSERT INTO PERSON_TEST VALUES (246810214, 1);
INSERT INTO PERSON_TEST VALUES (234567890, 2);
INSERT INTO PERSON_TEST VALUES (345678901, 5);

--PHU_TEST
INSERT INTO PHU_TEST VALUES (3, 1);
INSERT INTO PHU_TEST VALUES (4, 1);
INSERT INTO PHU_TEST VALUES (1, 1);
INSERT INTO PHU_TEST VALUES (2, 3);
INSERT INTO PHU_TEST VALUES (5, 2);

--HOSPITALIZATION
INSERT INTO HOSPITALIZATION_RECORDS VALUES (246810214, 1, '2022-09-01 08:00:00', 'icu_current_covid');
INSERT INTO HOSPITALIZATION_RECORDS VALUES (376678904, 7, '2022-09-07 20:00:00', 'icu_hospitalizations');
INSERT INTO HOSPITALIZATION_RECORDS VALUES (346549025, 6, '2022-09-06 18:00:00', 'icu_crci_total');
INSERT INTO HOSPITALIZATION_RECORDS VALUES (345678902, 11, '2022-09-05 16:00:00', 'icu_crci_total_vented');
INSERT INTO HOSPITALIZATION_RECORDS VALUES (123456789, 4, '2022-09-04 14:00:00', 'icu_current_covid_vented');

INSERT INTO HOSPITALIZATION_RECORDS VALUES (369258147, 8, '2022-01-01 08:00:00', 'icu_current_covid');
INSERT INTO HOSPITALIZATION_RECORDS VALUES (234567890, 9, '2022-11-07 20:00:00', 'icu_hospitalizations');
INSERT INTO HOSPITALIZATION_RECORDS VALUES (987654321, 10, '2022-10-06 18:00:00', 'icu_crci_total');
INSERT INTO HOSPITALIZATION_RECORDS VALUES (246810214, 11, '2022-02-05 16:00:00', 'icu_crci_total_vented');
INSERT INTO HOSPITALIZATION_RECORDS VALUES (456789123, 12, '2022-03-14 14:00:00', 'icu_current_covid_vented');

INSERT INTO HOSPITALIZATION_RECORDS VALUES (654321987, 13, '2022-09-11 09:20:00', 'icu_current_covid');
INSERT INTO HOSPITALIZATION_RECORDS VALUES (789456123, 14, '2022-08-27 23:30:00', 'icu_hospitalizations');
INSERT INTO HOSPITALIZATION_RECORDS VALUES (234567891, 15, '2022-09-16 13:40:00', 'icu_crci_total');
INSERT INTO HOSPITALIZATION_RECORDS VALUES (321654987, 16, '2022-07-25 15:50:00', 'icu_crci_total_vented');
INSERT INTO HOSPITALIZATION_RECORDS VALUES (369258147, 17, '2022-04-14 16:50:00', 'icu_current_covid_vented');

--VIEW

GO
-- AGE WISE BREAKDOWN OF POSITIVE CASES INCLUDING POSITIVITY RATES
CREATE VIEW TESTING_STATS (Age_grp,No_positive_cases,Positivity_rate)
AS SELECT T.AGE_GROUP_CODE, SUM(RESULT),( SUM(RESULT)/COUNT(*))*100
    FROM TEST AS T
    GROUP BY AGE_GROUP_CODE;


GO
-- AGE WISE BREAKDOWN OF VACCINE DATA
CREATE VIEW VACCINE_STATS(Age_grp,Vaccine_name,Total_people_vaccinated)
AS SELECT AG.DESCRIPTION,V.VACNAME,COUNT(*)
    FROM PERSON P, VACCINATION V, PEOPLE_VACCINATION_RECORDS PVR, AGEGROUP AG
	WHERE PVR.SSN = P.SSN AND PVR.VACID = V.VACID AND P.AGE_GROUP_CODE = AG.AGE_GROUP_CODE
	GROUP BY AG.AGE_GROUP_CODE,V.VACNAME, AG.DESCRIPTION;




GO
-- HOSPITALIZATION AND ICU INFOR PROVINCES
CREATE VIEW HOSPITALIZATION_ICU_PROVINCE(Patient_Name, Hospitalization_Date, ICU, Province)
AS 
	SELECT PERSON.NAME, HOSPITALIZATION_RECORDS.REPORTING_DATE, ICUGROUP.DESCRIPTION, PROVINCE.PROVINCE_NAME
    FROM HOSPITALIZATION_RECORDS, PROVINCE, PHU, PERSON, ICUGROUP
	WHERE HOSPITALIZATION_RECORDS.PHUID = PHU.PHUID AND PHU.PROVID = PROVINCE.PROVID AND HOSPITALIZATION_RECORDS.SSN = PERSON.SSN AND HOSPITALIZATION_RECORDS.ICU_CODE = ICUGROUP.ICU_CODE
	GROUP BY PERSON.NAME, HOSPITALIZATION_RECORDS.REPORTING_DATE, ICUGROUP.DESCRIPTION, PROVINCE.PROVINCE_NAME;




GO
-- HOSPITALIZATION AND ICU INFOR HEALTHREGION
CREATE VIEW HOSPITALIZATION_ICU_HEALTHREGION(Patient_Name, Province, Health_Region,PHU, ICU, Hospitalization_date)
AS SELECT 
	PERSON.NAME,
    PROVINCE.PROVINCE_NAME,
    HEALTHREGION.HEALTHREGION_NAME,
    PHU.NAME,
    ICUGROUP.DESCRIPTION,
    HOSPITALIZATION_RECORDS.REPORTING_DATE
FROM HOSPITALIZATION_RECORDS
INNER JOIN PERSON ON HOSPITALIZATION_RECORDS.SSN = PERSON.SSN
INNER JOIN PHU ON HOSPITALIZATION_RECORDS.PHUID = PHU.PHUID
INNER JOIN HEALTHREGION ON PHU.HEAREGID = HEALTHREGION.HEAREGID
INNER JOIN PROVINCE ON PHU.PROVID = PROVINCE.PROVID
LEFT JOIN ICUGROUP ON HOSPITALIZATION_RECORDS.ICU_CODE = ICUGROUP.ICU_CODE
GROUP BY PERSON.NAME, PROVINCE.PROVINCE_NAME, HEALTHREGION.HEALTHREGION_NAME, PHU.NAME, ICUGROUP.DESCRIPTION, HOSPITALIZATION_RECORDS.REPORTING_DATE;



-- Store PROCEDURE
GO
CREATE PROCEDURE SelectHospitalizations @ProvinceName nvarchar(30)
AS
	SELECT * 
	FROM HOSPITALIZATION_ICU_HEALTHREGION
	WHERE HOSPITALIZATION_ICU_HEALTHREGION.Province=@ProvinceName

EXEC SelectHospitalizations @ProvinceName = 'Ontario'




--Query for ICU and Hosp detail
SELECT 
    PROVINCE.PROVINCE_NAME,
    HEALTHREGION.HEALTHREGION_NAME,
    PHU.NAME,
    ICUGROUP.DESCRIPTION AS ICU_DESCRIPTION,
    COUNT(HOSPITALIZATION_RECORDS.SSN) AS TOTAL_HOSPITALIZATIONS,
    SUM(CASE WHEN HOSPITALIZATION_RECORDS.ICU_CODE IS NOT NULL THEN 1 ELSE 0 END) AS TOTAL_ICU_ADMISSIONS
FROM HOSPITALIZATION_RECORDS
INNER JOIN PERSON ON HOSPITALIZATION_RECORDS.SSN = PERSON.SSN
INNER JOIN PHU ON HOSPITALIZATION_RECORDS.PHUID = PHU.PHUID
INNER JOIN HEALTHREGION ON PHU.HEAREGID = HEALTHREGION.HEAREGID
INNER JOIN PROVINCE ON PHU.PROVID = PROVINCE.PROVID
LEFT JOIN ICUGROUP ON HOSPITALIZATION_RECORDS.ICU_CODE = ICUGROUP.ICU_CODE
GROUP BY PROVINCE.PROVINCE_NAME, HEALTHREGION.HEALTHREGION_NAME, PHU.NAME, ICUGROUP.DESCRIPTION
ORDER BY PROVINCE.PROVINCE_NAME, HEALTHREGION.HEALTHREGION_NAME, ICUGROUP.DESCRIPTION;